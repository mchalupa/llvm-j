<?xml version="1.0" encoding="UTF-8" ?>
<project name="llvm-j" basedir="." default="publish"
    xmlns:ivy="antlib:org.apache.ivy.ant">

  <property name="ivy.repo.url" value="https://www.sosy-lab.org/ivy"/>
  <property name="ivy.configurations" value="build, runtime" />
  <property name="ivy.settings.file" value="ivysettings.xml"/>

  <property name="src" location="src" />
  <property name="build" location="bin" />
  <property name="dist" location="dist" />
  <property name="lib.build" location="lib/native/build" />
  <property name="lib.native" location="lib/native" />
  <property name="jnaerator-jar" location="jnaerator.jar" />
  <property name="llvm.version" value="3.9.1" />
  <property name="llvm.library" location="${lib.build}/libLLVM-${llvm.version}.so" />
  <property name="llvm.bindings" location="src/main/java/org/llvm/binding/LLVMLibrary.java" />

  <path id="classpath">
    <fileset dir="lib" includes="*.jar" />
  </path>

  <target name="init">
    <mkdir dir="${build}" />
    <mkdir dir="${dist}" />
    <mkdir dir="${lib.build}" />
  </target>

  <target name="-check-bindings-exist" unless="bindings.exist">
    <available file="${llvm.bindings}" property="bindings.exist" />
  </target>

  <target name="-check-library-exists" unless="library.exist">
    <available file="${llvm.library}" property="library.exist" />
  </target>

  <target name="bindings" depends="-check-bindings-exist" unless="${bindings.exist}">
    <fail unless="llvm.home">
      Please specify the path to the directory
      of LLVM that includes the headers for C-bindings,
      i.e., ${llvm.home}/include/llvm-c .
      Use -Dllvm.home=/path/to/llvm to do that.
      Note that shell substitutions do not work and a full
      absolute path has to be specified.
    </fail>
    <exec executable="java">
      <env key="LLVM_HOME" file="${llvm.home}" />
      <arg value="-jar" />
      <arg value="jnaerator.jar" />
      <arg value="config.jnaerator" />
    </exec>

    <!-- Perform minor changes to bindings -->

    <!-- Set concrete LLVM version to avoid conflicts -->
    <replace file="${llvm.bindings}"
             token='JNA_LIBRARY_NAME = "LLVM";'
             value='JNA_LIBRARY_NAME = "LLVM-${llvm.version}";' />

    <!-- Remove jnaerator-imports.
         We want to provide our own util classes to be independent of jnaerator -->
    <replaceregexp file="${llvm.bindings}"
                   flags="g,s"
                   match="\nimport com\.ochafik\.lang\.jnaerator\.[a-zA-Z\.]*;"
                   replace="" />
    <!-- Replace static initializer with static method for initialization -->
    <replace file="${llvm.bindings}"
             token="static {"
             value="public static void instantiate() {" />

  </target>

  <target name="compile" depends="init, bindings">
    <javac srcdir="${src}" destdir="${build}" encoding="UTF-8">
      <classpath refid="classpath" />
    </javac>
  </target>

  <target name="download-library" depends="init, -check-library-exists" unless="${library.exist}">
    <exec executable="${lib.native}/download_lib.sh" dir="${lib.build}">
      <arg value="${llvm.version}" />
    </exec>
  </target>

  <target name="publish" depends="compile, download-library">
    <fail unless="llvm.library">
      Please specify the path to the LLVM-${llvm.version} shared
      library using -Dllvm.library=FILENAME.
    </fail>

    <jar destfile="${dist}/llvm-j.jar" basedir="${build}">
      <manifest>
      </manifest>
    </jar>

    <copy file="${llvm.library}" tofile="${dist}/libLLVM-${llvm.version}.so" />

    <ivy:resolve conf="runtime" />
    <available property="ivy.hasrepository" file="repository/${ivy.organisation}/${ivy.module}" />
    <fail unless="ivy.hasrepository">
      Cannot publish without directory respository/ .
      Please run 'svn co https://svn.sosy-lab.org/software/ivy/repository/${ivy.organisation}/${ivy.module} repository/${ivy.organisation}/${ivy.module}'.
    </fail>

    <ivy:publish
      pubrevision="${llvm.version}"
      resolver="Sosy-Lab-Publish"
      artifactspattern="dist/[artifact]-[revision].[ext]"
      status="release"
    />

    <echo>
     You now want to run
      svn add repository/${ivy.organisation}/${ivy.module}/*-${llvm.version}*
      svn ci repository/${ivy.organisation}/${ivy.module} -m"publish version ${llvm.version} of llvm-j"
    to make the new version publicly available.
    </echo>
  </target>

  <target name="clean">
    <delete dir="${build}" />
    <delete dir="${dist}" />
    <delete dir="${lib.build}" />
    <delete file="${llvm.bindings}" />
  </target>
</project>
