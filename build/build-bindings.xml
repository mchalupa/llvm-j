<?xml version="1.0" encoding="UTF-8" ?>
<!-- vim: set tabstop=8 shiftwidth=4 expandtab filetype=ant : -->
<project name="bindings" basedir=".">

    <path id="jnaerator.classpath">
      <fileset dir="${ivy.lib.dir}" includes="build/*.jar"/>
    </path>

    <target name="-check-bindings-exist" unless="bindings.exist">
        <available file="${llvm.bindings}" property="bindings.exist" />
    </target>

    <target name="bindings" depends="-check-bindings-exist, build-dependencies"
        unless="${bindings.exist}">
        <fail unless="llvm.home">
            Please specify the path to the directory
            of LLVM that includes the headers for C-bindings,
            i.e., ${llvm.home}/include/llvm-c .
            Use -Dllvm.home=/path/to/llvm to do that.
            Note that shell substitutions do not work and a full
            absolute path has to be specified.
        </fail>
        <fail unless="llvm.version">
            Please specify the llvm version with the flag -Dllvm.version=... .
        </fail>

        <java classname="com.ochafik.lang.jnaerator.JNAerator"
              classpathref="jnaerator.classpath"
              fork="true">
            <env key="LLVM_HOME" file="${llvm.home}" />
        </java>

        <!-- Perform minor changes to bindings -->

        <!-- Set concrete LLVM version to avoid conflicts -->
        <replace file="${llvm.bindings}"
                token="JNA_LIBRARY_NAME = &quot;LLVM&quot;;"
                value="JNA_LIBRARY_NAME = &quot;LLVM-${llvm.version}&quot;;" />

        <!-- Remove jnaerator-imports.
             We want to provide our own util classes to be independent of jnaerator -->
        <replaceregexp file="${llvm.bindings}"
                       flags="g,s"
                       match="\nimport com\.ochafik\.lang\.jnaerator\.[a-zA-Z    \.]*;"
                       replace="" />
        <!-- Replace static initializer with static method for initialization     -->
        <replace file="${llvm.bindings}"
                 token="static {"
                 value="public static void instantiate() {" />

        <!-- Format bindings to adhere to our styleguide as far as possible -->
        <property name="format.selection" location="${llvm.bindings}" />
        <antcall target="format-selection" />
    </target>

</project>
